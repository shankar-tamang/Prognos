<!DOCTYPE html>
<html lang="en" class="bg-gray-100 text-gray-900">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <!-- âœ… META for mobile display -->
  <title>Medical Chat Assistant</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- html2pdf.js for PDF download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <style>
    .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
    .prose li { margin-bottom: 0.25rem; }
    .prose h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
    .prose p { margin-bottom: 0.5rem; }
  </style>
</head>
<body class="transition-colors duration-300 bg-gray-100 dark:bg-gray-900 dark:text-gray-100 min-h-screen flex flex-col items-center justify-center px-2 py-4">

  <!-- Toast Notification -->
  <div id="toast" class="fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg hidden z-50"></div>

  <!-- App Container -->
  <div class="w-full max-w-3xl bg-white dark:bg-gray-800 shadow-lg rounded-lg overflow-hidden flex flex-col">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 bg-blue-600 dark:bg-blue-700 text-white text-xl font-semibold">
      ðŸ©º Medical Chat Assistant
      <button onclick="toggleDarkMode()" class="text-sm px-2 py-1 border border-white rounded hover:bg-white hover:text-blue-600 transition">ðŸŒ“ Mode</button>
    </div>

    <!-- Chat Window -->
    <div id="chat-container" class="p-4 h-[450px] sm:h-[550px] overflow-y-auto space-y-4 text-sm sm:text-base bg-gray-50 dark:bg-gray-700">
      <div class="text-center text-gray-500 dark:text-gray-300">Type "New case" to start.</div>
    </div>

    <!-- Input Area -->
    <div class="p-4 border-t dark:border-gray-700 flex flex-col sm:flex-row gap-2">
      <input id="user-input" type="text" placeholder="Type your message..."
             class="flex-grow border dark:border-gray-600 bg-white dark:bg-gray-800 rounded px-4 py-2 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <div class="flex gap-2">
        <button id="send-btn" class="bg-blue-600 text-white px-4 py-2 rounded text-sm sm:text-base">
          Send
        </button>
        <button id="download-btn" class="bg-green-600 text-white px-4 py-2 rounded text-sm sm:text-base hidden">
          Download PDF
        </button>
      </div>
    </div>
  </div>

  <script>
    let step = -1;
    let answers = {};
    const keys = ["complaint_duration", "key_findings_vitals", "relevant_history"];

    // Handle sending
    document.getElementById('send-btn').onclick = async () => {
      const userInput = document.getElementById('user-input').value;
      if (!userInput.trim()) return;

      appendChat("Doctor", userInput);
      document.getElementById('user-input').value = "";

      if (step === -1 && ["new case", "start new patient file", "log new patient"].includes(userInput.toLowerCase())) {
        step = 0;
        await getNextQuestion();
      } else if (step >= 0 && step < keys.length) {
        answers[keys[step]] = userInput;
        step++;
        await getNextQuestion();
      } else {
        appendChat("Chatbot", "Please type 'New case' to start a new conversation.");
      }
    };

    // Get next question
    async function getNextQuestion() {
      if (step < keys.length) {
        const res = await axios.post('/get_question', { step });
        if (!res.data.done) appendChat("Chatbot", res.data.question);
      } else {
        appendChat("Chatbot", "Generating report...");
        const res = await axios.post('/generate_report', { answers });
        if (res.data.success) {
          appendChat("Chatbot", res.data.report, true);
          document.getElementById('download-btn').classList.remove('hidden');
        } else {
          appendChat("Chatbot", "Error generating report: " + res.data.error);
        }
        step = -1;
        answers = {};
      }
    }

    // Append chat message
    function appendChat(sender, message, isReport = false) {
      const chat = document.getElementById('chat-container');
      let bubbleHTML;
      if (isReport) {
        bubbleHTML = `
          <div class="w-full mr-auto p-4 bg-white dark:bg-gray-900 shadow rounded" id="report-content">
            <div class="prose prose-sm sm:prose dark:prose-invert">${message}</div>
          </div>`;
      } else {
        const bubbleClass = sender === "Doctor"
          ? "bg-blue-500 text-white ml-auto"
          : "bg-gray-200 dark:bg-gray-600 text-black dark:text-white mr-auto";
        bubbleHTML = `<div class="max-w-[80%] ${bubbleClass} px-3 py-2 rounded text-sm sm:text-base">${message}</div>`;
      }

      chat.innerHTML += bubbleHTML;
      chat.scrollTop = chat.scrollHeight;
    }

    // Enter = send
    document.getElementById('user-input').addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        document.getElementById('send-btn').click();
      }
    });

    // PDF Download
    document.getElementById('download-btn').onclick = () => {
      const element = document.getElementById("report-content");
      if (!element) return showToast("âš ï¸ No report to download.");
      const opt = {
        margin: 0.5,
        filename: 'medical_report.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };
      html2pdf().from(element).set(opt).save().then(() => {
        showToast("âœ… Report downloaded as PDF.");
      });
    };

    // Theme toggle
    function toggleDarkMode() {
      document.documentElement.classList.toggle("dark");
    }

    // Toast Notification
    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.innerText = msg;
      toast.classList.remove("hidden");
      setTimeout(() => toast.classList.add("hidden"), 3000);
    }
  </script>
</body>
</html>
