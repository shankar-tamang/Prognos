<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Medical Chat Assistant</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <!-- html2pdf.js for PDF download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- Optional: fallback styles for prose -->
  <style>
    .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
    .prose li { margin-bottom: 0.25rem; }
    .prose h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
    .prose p { margin-bottom: 0.5rem; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-3xl mx-auto my-6 px-4 sm:px-6">
    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
      <div class="p-4 bg-blue-600 text-white text-xl font-semibold">
        ðŸ©º Medical Chat Assistant
      </div>

      <div id="chat-container" class="p-4 h-[400px] sm:h-[500px] overflow-y-auto space-y-4 text-sm sm:text-base">
        <div class="text-center text-gray-500">Type "New case" to start.</div>
      </div>

      <div class="p-4 border-t flex flex-col sm:flex-row gap-2">
        <input id="user-input" type="text" placeholder="Type your message..." class="flex-grow border rounded px-4 py-2">
        <button id="send-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Send</button>
        <button id="download-btn" class="bg-green-600 text-white px-4 py-2 rounded hidden">Download PDF</button>
      </div>
    </div>
  </div>

  <script>
    let step = -1;
    let answers = {};
    const keys = ["complaint_duration", "key_findings_vitals", "relevant_history"];

    document.getElementById('send-btn').onclick = async () => {
      const userInput = document.getElementById('user-input').value;
      if (!userInput.trim()) return;

      appendChat("Doctor", userInput);
      document.getElementById('user-input').value = "";

      if (step === -1 && ["new case", "start new patient file", "log new patient"].includes(userInput.toLowerCase())) {
        step = 0;
        await getNextQuestion();
      } else if (step >= 0 && step < keys.length) {
        answers[keys[step]] = userInput;
        step++;
        await getNextQuestion();
      } else {
        appendChat("Chatbot", "Please type 'New case' to start a new conversation.");
      }
    };

    async function getNextQuestion() {
      if (step < keys.length) {
        const res = await axios.post('/get_question', { step });
        if (!res.data.done) appendChat("Chatbot", res.data.question);
      } else {
        appendChat("Chatbot", "Generating report...");
        const res = await axios.post('/generate_report', { answers });
        if (res.data.success) {
          appendChat("Chatbot", res.data.report, true);
          document.getElementById('download-btn').classList.remove('hidden');
        } else {
          appendChat("Chatbot", "Error generating report: " + res.data.error);
        }
        step = -1;
        answers = {};
      }
    }

    function appendChat(sender, message, isReport = false) {
      const chat = document.getElementById('chat-container');
      let bubbleHTML;

      if (isReport) {
        bubbleHTML = `<div class="max-w-full mr-auto p-4 bg-white shadow rounded" id="report-content">
                        <div class="prose prose-sm sm:prose">${message}</div>
                      </div>`;
      } else {
        const bubbleClass = sender === "Doctor" ? "bg-blue-500 text-white ml-auto" : "bg-gray-200 mr-auto";
        bubbleHTML = `<div class="max-w-[80%] ${bubbleClass} px-3 py-2 rounded">${message}</div>`;
      }

      chat.innerHTML += bubbleHTML;
      chat.scrollTop = chat.scrollHeight;
    }

    document.getElementById('user-input').addEventListener("keydown", function(event) {
      if (event.key === "Enter") {
        document.getElementById('send-btn').click();
      }
    });

    // PDF download
    document.getElementById('download-btn').onclick = () => {
      const element = document.getElementById("report-content");
      if (!element) return alert("No report to download.");
      const opt = {
        margin: 0.5,
        filename: 'medical_report.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };
      html2pdf().from(element).set(opt).save();
    };
  </script>
</body>
</html>
